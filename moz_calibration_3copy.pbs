#!/bin/bash
#PBS -l walltime=72:00:00
#PBS -N MozCalibration3
#PBS -q nd
#PBS -l select=1:ncpus=50:host=nd04
#PBS -o MozCalibration3.output
#PBS -e MozCalibration3.error


cd $PBS_O_WORKDIR

echo "Current folder: $(pwd)"

MAX_PARALLEL=100
CURRENT=0
INDEX=0

function wait_for_available_slot() {
    while (( $(jobs -r | wc -l) >= MAX_PARALLEL )); do
        sleep 0.5  # <<< check every 0.5s if a slot is free
    done
}

while IFS= read -r line || [[ -n "$line" ]]; do
    if [[ -n "$line" ]]; then
        wait_for_available_slot  # <<< wait if too many jobs

        echo "Running: $line"
        eval "$line" > ${INDEX}.output 2> ${INDEX}.error &

        ((INDEX++))
    fi
done < ./moz_20000_cmds.txt

# Final wait for all remaining jobs
wait

echo "All jobs completed."
